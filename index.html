<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare Pro</title>
  <!-- Importation des polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Importation de Font Awesome pour les icônes -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Variables CSS pour les couleurs */
    :root {
      --primary-color: #007AFF;
      --secondary-color: #5856D6;
      --accent-color: #34C759;
      --background-color: #FFFFFF;
      --text-color: #000000;
      --light-gray: #F2F2F7;
      --card-background: #FFFFFF;
      --card-shadow: rgba(0, 0, 0, 0.05);
      --highlight-color: rgba(255, 59, 48, 0.3);
    }

    /* Styles globaux */
    html, body {
      overflow-x: hidden;
    }

    body {
      font-family: 'SF Pro Display', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Style du header */
    header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #00A1FF 100%);
      color: white;
      width: 100%;
      padding: 15px 20px;
      position: fixed;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header img {
      width: 35px;
      border-radius: 8px;
      margin-right: 15px;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      font-weight: 600;
      flex-grow: 1;
      text-align: center;
    }

    /* Style de la navigation flottante en bas */
    nav {
      background: var(--card-background);
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      z-index: 999;
      border-top: 1px solid var(--light-gray);
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }

    nav button {
      background: none;
      border: none;
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: color 0.3s ease;
    }

    nav button.active {
      color: var(--primary-color);
    }

    nav button i {
      font-size: 24px;
      margin-bottom: 3px;
    }

    /* Style des conteneurs */
    .container {
      max-width: 600px;
      width: 90%;
      margin-top: 80px;
      margin-bottom: 80px;
      padding: 20px;
      background: var(--card-background);
      border-radius: 20px;
      box-shadow: 0 4px 16px var(--card-shadow);
      display: none;
      margin-left: auto;
      margin-right: auto;
    }

    .container.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 {
      color: var(--secondary-color);
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 24px;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: 500;
      color: var(--text-color);
      font-size: 16px;
    }

    /* Style des inputs */
    textarea,
    select,
    input[type="file"],
    input[type="number"] {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      border: 1px solid var(--light-gray);
      border-radius: 12px;
      box-sizing: border-box;
      font-size: 16px;
      background-color: var(--light-gray);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    textarea {
      min-height: 200px;
      resize: vertical;
    }

    textarea:focus,
    select:focus,
    input[type="file"]:focus,
    input[type="number"]:focus {
      border-color: var(--primary-color);
      outline: none;
      background-color: #fff;
      box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    /* Boutons principaux */
    button.primary-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent-color) 0%, #28CD41 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 30px;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    button.primary-btn:active {
      transform: scale(0.98);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    button.primary-btn:hover {
      background: linear-gradient(135deg, #28A745 0%, #20C15E 100%);
    }

    /* Style des résultats */
    .result {
      background: var(--background-color);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Illustration 2D du corps humain */
    #bodyDiagram {
      width: 100%;
      height: 400px;
      margin-top: 20px;
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    #bodyDiagram svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .view-switcher {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }

    .view-switcher button {
      background: none;
      border: none;
      margin: 0 10px;
      font-size: 16px;
      color: var(--text-color);
      cursor: pointer;
      transition: color 0.3s ease, background-color 0.3s ease;
      padding: 5px 10px;
      border-radius: 8px;
    }

    .view-switcher button.active {
      color: var(--primary-color);
      font-weight: 600;
      background-color: var(--light-gray);
    }

    /* Loader */
    #loader {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      font-size: 18px;
      color: var(--secondary-color);
    }

    /* Style des régions surlignées */
    .highlight-region {
      fill: var(--highlight-color);
    }

    /* Adaptation responsive */
    @media (max-width: 600px) {
      header h1 {
        font-size: 20px;
      }

      nav button i {
        font-size: 20px;
      }

      h2 {
        font-size: 22px;
      }

      button.primary-btn {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <header>
    <img src="logo.png" alt="Logo PhysioCare">
    <h1>PhysioCare Pro</h1>
  </header>

  <nav>
    <button class="active" onclick="showStep(1)">
      <i class="fas fa-user"></i>
      <span>Infos</span>
    </button>
    <button onclick="showStep(2)">
      <i class="fas fa-notes-medical"></i>
      <span>Symptômes</span>
    </button>
    <button onclick="showStep(3)">
      <i class="fas fa-diagnoses"></i>
      <span>Diagnostic</span>
    </button>
    <button onclick="showStep(4)">
      <i class="fas fa-stethoscope"></i>
      <span>Traitement</span>
    </button>
  </nav>

  <!-- Étape 1 : Informations Patient -->
  <div class="container active" id="step1">
    <h2>Informations du Patient</h2>
    <label for="gender">Genre :</label>
    <select id="gender">
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="age">Âge :</label>
    <select id="age">
      <option value="18-30">18-30</option>
      <option value="31-50">31-50</option>
      <option value="51-70">51-70</option>
      <option value="71+">71+</option>
    </select>

    <label for="weight">Poids (kg) :</label>
    <input type="number" id="weight" placeholder="Exemple : 70">

    <label for="height">Taille (cm) :</label>
    <input type="number" id="height" placeholder="Exemple : 175">

    <label for="sport">Activité Sportive :</label>
    <select id="sport">
      <option value="Aucune">Aucune</option>
      <option value="Occasionnelle">Occasionnelle</option>
      <option value="Régulière">Régulière</option>
      <option value="Professionnelle">Professionnelle</option>
    </select>

    <label for="conditions">Conditions Médicales Spécifiques :</label>
    <textarea id="conditions" placeholder="Exemple : Diabète, hypertension, etc."></textarea>
  </div>

  <!-- Étape 2 : Symptômes -->
  <div class="container" id="step2">
    <h2>Symptômes et Analyses Médicales</h2>
    <label for="symptoms">Symptômes :</label>
    <textarea id="symptoms" placeholder="Décrivez les symptômes du patient..."></textarea>

    <label for="fileInput">Télécharger des fichiers d'analyse (PDF ou Images) :</label>
    <input type="file" id="fileInput" multiple accept="image/*,application/pdf">
  </div>

  <!-- Étape 3 : Diagnostic -->
  <div class="container" id="step3">
    <h2>Diagnostic</h2>
    <button class="primary-btn" onclick="confirmGenerateDiagnosis()">Obtenir le Diagnostic</button>
    <div id="loader" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i>&nbsp;Analyse en cours...
    </div>
    <div id="diagnosisResult" class="result">Résultat du diagnostic : En attente...</div>

    <div id="bodyDiagram">
      <!-- SVG du corps humain -->
      <svg id="humanBodySVG" viewBox="0 0 200 500" preserveAspectRatio="xMidYMid meet">
        <!-- Vue de face -->
        <g id="frontView">
          <!-- Importez ici un SVG détaillé du corps humain avec des IDs pour chaque partie -->
          <!-- Exemple simplifié -->
          <path id="head" d="M100,50 a30,30 0 1,0 0.1,0" stroke="#000" fill="#e0e0e0" />
          <!-- Ajoutez les autres parties du corps avec des IDs appropriés -->
        </g>
        <!-- Vue de profil -->
        <g id="sideView" style="display:none;">
          <!-- Importez ici un SVG détaillé de la vue de profil -->
        </g>
        <!-- Vue de dos -->
        <g id="backView" style="display:none;">
          <!-- Importez ici un SVG détaillé de la vue de dos -->
        </g>
      </svg>
    </div>
    <div class="view-switcher">
      <button class="active" onclick="switchView('front')">Face</button>
      <button onclick="switchView('side')">Profil</button>
      <button onclick="switchView('back')">Dos</button>
    </div>
  </div>

  <!-- Étape 4 : Plan de Traitement -->
  <div class="container" id="step4">
    <h2>Plan de Traitement</h2>
    <div id="treatmentPlan" class="result">
      En attente du diagnostic pour générer le plan de traitement...
    </div>
    <button class="primary-btn" onclick="downloadTreatmentPlanPDF()">Télécharger le Plan de Traitement en PDF</button>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script>
    // Navigation
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) container.classList.add('active');
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    // Changement de vue du modèle corporel
    function switchView(view) {
      const frontView = document.getElementById('frontView');
      const sideView = document.getElementById('sideView');
      const backView = document.getElementById('backView');
      const buttons = document.querySelectorAll('.view-switcher button');
      buttons.forEach(button => button.classList.remove('active'));

      frontView.style.display = 'none';
      sideView.style.display = 'none';
      backView.style.display = 'none';

      if (view === 'front') {
        frontView.style.display = 'block';
        buttons[0].classList.add('active');
      } else if (view === 'side') {
        sideView.style.display = 'block';
        buttons[1].classList.add('active');
      } else if (view === 'back') {
        backView.style.display = 'block';
        buttons[2].classList.add('active');
      }
    }

    // Confirmation et génération du diagnostic
    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    // Génération du diagnostic
    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value;
      const symptoms = document.getElementById("symptoms").value;

      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");

      diagnosisResult.textContent = "";
      loader.style.display = "flex";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `Patient: Genre : ${gender}, Âge : ${age}, Poids : ${weight}, Taille : ${height}, Sport : ${sport}, Conditions médicales : ${conditions}, Symptômes : ${symptoms}.`,
              },
            ],
          }),
        });

        const data = await response.json();

        // Vérifier si la réponse contient le contenu attendu
        if (data && data.content) {
          const diagnosisText = data.content.trim();
          diagnosisResult.textContent = diagnosisText;

          // Surligner les parties affectées sur le modèle corporel 2D
          highlightAffectedRegions(diagnosisText);
          generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosisText);
        } else {
          throw new Error("Réponse inattendue de l'API.");
        }
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    // Fonction pour surligner les régions affectées sur le modèle corporel 2D
    function highlightAffectedRegions(diagnosisText) {
      // Réinitialiser les surlignages précédents
      const svgElements = document.querySelectorAll('#humanBodySVG *');
      svgElements.forEach(element => {
        element.classList.remove('highlight-region');
      });

      // Mappage des régions corporelles avec les IDs dans le SVG
      const regionsMap = {
        "tête": ["head"],
        "cou": ["neck"],
        "épaule": ["leftShoulder", "rightShoulder"],
        "épaule gauche": ["leftShoulder"],
        "épaule droite": ["rightShoulder"],
        "bras gauche": ["leftArm"],
        "bras droit": ["rightArm"],
        "poignet gauche": ["leftWrist"],
        "poignet droit": ["rightWrist"],
        "main gauche": ["leftHand"],
        "main droite": ["rightHand"],
        "poitrine": ["chest"],
        "abdomen": ["abdomen"],
        "dos": ["back"],
        "hanche gauche": ["leftHip"],
        "hanche droite": ["rightHip"],
        "jambe gauche": ["leftLeg"],
        "jambe droite": ["rightLeg"],
        "genou gauche": ["leftKnee"],
        "genou droit": ["rightKnee"],
        "cheville gauche": ["leftAnkle"],
        "cheville droite": ["rightAnkle"],
        "pied gauche": ["leftFoot"],
        "pied droit": ["rightFoot"],
        // Ajouter d'autres régions si nécessaire
      };

      for (const [region, ids] of Object.entries(regionsMap)) {
        if (diagnosisText.toLowerCase().includes(region)) {
          ids.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
              element.classList.add('highlight-region');
            }
          });
        }
      }
    }

    // Génération du plan de traitement
    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.textContent = "Création du plan de traitement en cours...";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes: ${symptoms}

Diagnostic: ${diagnosis}

Tâche : Basé sur les informations ci-dessus, générez une **proposition théorique de protocole de soins très précis et personnalisé à valider par un kinésithérapeute**, parfaitement adapté aux spécificités du patient et de ses symptômes et basé uniquement sur l'état de l'art le plus fiable et récent dans le domaine de la kinésithérapie. Ne donnez pas de diagnostic. Précisez que ce protocole doit impérativement être validé par un professionnel avant application. Répondez uniquement sous la forme d'une liste à puces avec des **recommandations claires** pour les soins, exercices ou traitements.`,
              },
            ],
          }),
        });

        const data = await response.json();

        // Vérifier si la réponse contient le contenu attendu
        if (data && data.content) {
          treatmentPlan.textContent = data.content.trim();
        } else {
          throw new Error("Réponse inattendue de l'API.");
        }
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }

    // Téléchargement du plan de traitement en PDF
    function downloadTreatmentPlanPDF() {
      const { jsPDF } = window.jspdf;
      const treatmentPlanText = document.getElementById('treatmentPlan').innerText;

      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Plan de Traitement Personnalisé", 10, 10);
      doc.setFontSize(12);
      doc.text(treatmentPlanText, 10, 20, { maxWidth: 180 });

      doc.save("Plan_de_Traitement.pdf");
    }
  </script>
</body>

</html>
