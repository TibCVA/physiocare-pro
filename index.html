<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare Pro</title>
  <!-- Importation des polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Importation de Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <style>
    /* Variables CSS pour les couleurs */
    :root {
      --primary-color: #4A90E2;
      --secondary-color: #007bff;
      --accent-color: #28a745;
      --background-color: #f8f9fa;
      --text-color: #333;
      --light-gray: #e9ecef;
      --error-color: #ff4d4d;
      --card-background: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
    }

    /* Styles globaux */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Style du header */
    header {
      background-color: var(--primary-color);
      color: white;
      width: 100%;
      text-align: center;
      padding: 10px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    header img {
      width: 30px;
      margin-right: 8px;
      border-radius: 50%;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      font-weight: 700;
    }

    /* Style de la navigation flottante en bas */
    nav {
      background: var(--light-gray);
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      z-index: 999;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.15);
      border-radius: 20px 20px 0 0;
    }

    nav button {
      background: none;
      border: none;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    nav button.active {
      color: var(--accent-color);
    }

    nav button i {
      font-size: 24px;
      margin-bottom: 3px;
    }

    nav button span {
      font-size: 12px;
    }

    /* Style des conteneurs */
    .container {
      max-width: 100%;
      width: 90%;
      margin: 100px auto;
      padding: 20px;
      background: var(--card-background);
      box-shadow: 0 2px 10px var(--card-shadow);
      border-radius: 20px;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .container.active {
      display: block;
      opacity: 1;
    }

    h2 {
      color: var(--secondary-color);
      border-left: 5px solid var(--secondary-color);
      padding-left: 10px;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 20px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    /* Style des inputs */
    textarea, select, input[type="file"], input[type="number"] {
      width: 100%;
      padding: 15px;
      margin-top: 5px;
      border: 1px solid #ced4da;
      border-radius: 12px;
      box-sizing: border-box;
      font-size: 14px;
      background-color: var(--light-gray);
      transition: border-color 0.3s ease;
      box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.1);
    }

    textarea:focus, select:focus, input[type="file"]:focus, input[type="number"]:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 5px var(--accent-color);
    }

    textarea::placeholder, select::placeholder, input::placeholder {
      color: #999;
    }

    /* Style des boutons */
    button.primary-btn {
      width: 100%;
      padding: 15px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button.primary-btn:hover {
      background-color: #218838;
      transform: translateY(-3px);
    }

    /* Style des résultats */
    .result {
      background: var(--light-gray);
      padding: 20px;
      border-radius: 15px;
      margin-top: 30px;
      white-space: pre-wrap;
      font-size: 16px;
      font-family: 'Roboto Mono', monospace;
      border: 1px solid var(--secondary-color);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    /* Canvas pour le modèle 3D */
    #model3D {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      nav button {
        padding: 8px;
        font-size: 14px;
      }

      header h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo PhysioCare">
    <h1>PhysioCare Pro</h1>
  </header>

  <nav>
    <button class="active" onclick="showStep(1)">
      <i class="fas fa-user"></i>
      <span>Infos</span>
    </button>
    <button onclick="showStep(2)">
      <i class="fas fa-notes-medical"></i>
      <span>Symptômes</span>
    </button>
    <button onclick="showStep(3)">
      <i class="fas fa-diagnoses"></i>
      <span>Diagnostic</span>
    </button>
    <button onclick="showStep(4)">
      <i class="fas fa-stethoscope"></i>
      <span>Traitement</span>
    </button>
  </nav>

  <!-- Étape 1 : Informations Patient -->
  <div class="container active" id="step1">
    <h2>Informations du Patient</h2>
    <label for="gender">Genre :</label>
    <select id="gender">
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="age">Âge :</label>
    <select id="age">
      <option value="18-30">18-30</option>
      <option value="31-50">31-50</option>
      <option value="51-70">51-70</option>
      <option value="71+">71+</option>
    </select>

    <label for="weight">Poids (kg) :</label>
    <input type="number" id="weight" placeholder="Exemple : 70">
    <span class="error-message"></span>

    <label for="height">Taille (cm) :</label>
    <input type="number" id="height" placeholder="Exemple : 175">
    <span class="error-message"></span>

    <label for="sport">Activité Sportive :</label>
    <select id="sport">
      <option value="Aucune">Aucune</option>
      <option value="Occasionnelle">Occasionnelle</option>
      <option value="Régulière">Régulière</option>
      <option value="Professionnelle">Professionnelle</option>
    </select>

    <label for="conditions">Conditions Médicales Spécifiques :</label>
    <textarea id="conditions" placeholder="Exemple : Diabète, hypertension, etc."></textarea>
  </div>

  <!-- Étape 2 : Symptômes -->
  <div class="container" id="step2">
    <h2>Symptômes et Analyses Médicales</h2>
    <label for="symptoms">Symptômes :</label>
    <textarea id="symptoms" placeholder="Exemple : Douleur au dos, faiblesse musculaire..."></textarea>

    <label for="fileInput">Télécharger des fichiers d'analyse (PDF ou Images) :</label>
    <input type="file" id="fileInput" multiple accept="image/*,application/pdf">
  </div>

  <!-- Étape 3 : Diagnostic -->
  <div class="container" id="step3">
    <h2>Diagnostic</h2>
    <button class="primary-btn" onclick="confirmGenerateDiagnosis()">Obtenir le Diagnostic</button>
    <div id="diagnosisResult" class="result">Résultat du diagnostic : En attente...</div>
    <div id="model3D"></div>
    <div id="loader" style="display: none;">
      <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i> Analyse en cours...
    </div>
  </div>

  <!-- Étape 4 : Plan de Traitement -->
  <div class="container" id="step4">
    <h2>Plan de Traitement</h2>
    <div id="treatmentPlan" class="result">
      En attente du diagnostic pour générer le plan de traitement...
    </div>
    <button class="primary-btn" onclick="downloadTreatmentPlanPDF()">Télécharger le Plan de Traitement en PDF</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script>
    // Navigation
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) container.classList.add('active');
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    // Confirmation et génération du diagnostic
    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    // Fonction d'intégration du modèle 3D
    function load3DModel() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 400, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth * 0.9, 400);
      document.getElementById("model3D").appendChild(renderer.domElement);

      const geometry = new THREE.SphereGeometry(1, 32, 32);
      const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
      const sphere = new THREE.Mesh(geometry, material);
      scene.add(sphere);

      camera.position.z = 5;

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
    }

    // Charger le modèle 3D au début
    window.onload = () => load3DModel();

    // Génération du diagnostic
    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value;
      const symptoms = document.getElementById("symptoms").value;

      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");

      diagnosisResult.textContent = "";
      loader.style.display = "block";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `Patient: Genre : ${gender}, Âge : ${age}, Poids : ${weight}, Taille : ${height}, Sport : ${sport}, Conditions médicales : ${conditions}, Symptômes : ${symptoms}.`,
              },
            ],
          }),
        });

        const data = await response.json();
        const diagnosisText = data.content.trim();
        diagnosisResult.textContent = diagnosisText;

        generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosisText);
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    // Génération du plan de traitement
    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.textContent = "Création du plan de traitement en cours...";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes: ${symptoms}

Diagnostic: ${diagnosis}

Tâche : Basé sur les informations ci-dessus, générez une **proposition théorique de protocole de soins très précis et personnalisé à valider par un kinésithérapeute**, parfaitement adapté aux spécificités du patient et de ses symptômes et basé uniquement sur l'état de l'art le plus fiable et récent dans le domaine de la kinésithérapie. Ne donnez pas de diagnostic. Précisez que ce protocole doit impérativement être validé par un professionnel avant application. Répondez uniquement sous la forme d'une liste à puces avec des **recommandations claires** pour les soins, exercices ou traitements.`,
              },
            ],
          }),
        });

        const data = await response.json();
        treatmentPlan.textContent = data.content.trim();
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }

    // Téléchargement du plan de traitement en PDF
    function downloadTreatmentPlanPDF() {
      const { jsPDF } = window.jspdf;
      const treatmentPlanText = document.getElementById('treatmentPlan').innerText;

      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Plan de Traitement Personnalisé", 10, 10);
      doc.setFontSize(12);
      doc.text(treatmentPlanText, 10, 20);

      doc.save("Plan_de_Traitement.pdf");
    }
  </script>
</body>
</html>
