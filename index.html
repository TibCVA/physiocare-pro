<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare Pro</title>
  <!-- Importation des polices Apple San Francisco -->
  <style>
    @font-face {
      font-family: 'SF Pro';
      src: url('fonts/SF-Pro-Display-Regular.otf') format('opentype');
    }
    @font-face {
      font-family: 'SF Pro Bold';
      src: url('fonts/SF-Pro-Display-Bold.otf') format('opentype');
    }
  </style>
  <!-- Importation de Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Importation de Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- Importation de PDF.js pour l'analyse des PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <style>
    /* Variables CSS pour les couleurs */
    :root {
      --primary-color: #0A84FF;
      --background-color: #FFFFFF;
      --text-color: #000000;
      --light-gray: #F2F2F7;
      --error-color: #FF3B30;
    }

    /* Styles globaux */
    body {
      font-family: 'SF Pro', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    /* Style du header */
    header {
      background-color: var(--background-color);
      color: var(--text-color);
      width: 100%;
      text-align: center;
      padding: 10px 0;
      border-bottom: 1px solid #E5E5EA;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header img {
      width: 50px;
      margin-bottom: 5px;
    }

    header h1 {
      font-size: 22px;
      margin: 0;
      font-weight: 700;
      font-family: 'SF Pro Bold';
    }

    /* Style de la navigation */
    nav {
      background-color: var(--background-color);
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-bottom: 1px solid #E5E5EA;
    }

    nav button {
      background: none;
      border: none;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 500;
      border-radius: 10px;
      display: flex;
      align-items: center;
      transition: background-color 0.3s ease;
    }

    nav button.active {
      background-color: #E5E5EA;
    }

    nav button i {
      margin-right: 8px;
      font-size: 18px;
    }

    /* Style des conteneurs */
    .container {
      max-width: 100%;
      width: 90%;
      margin: 20px auto;
      padding: 20px;
      background: var(--background-color);
      border-radius: 15px;
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    .container.active {
      display: block;
    }

    h2 {
      color: var(--text-color);
      margin-bottom: 20px;
      font-weight: 700;
      font-family: 'SF Pro Bold';
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
    }

    /* Style des inputs */
    textarea, select, input[type="file"], input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #CED0CE;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 16px;
      background-color: var(--light-gray);
      transition: border-color 0.3s ease;
      font-family: 'SF Pro';
    }

    textarea:focus, select:focus, input[type="file"]:focus, input[type="number"]:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    textarea::placeholder, select::placeholder, input::placeholder {
      color: #8E8E93;
    }

    /* Style des boutons */
    button.primary-btn {
      width: 100%;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      font-family: 'SF Pro';
    }

    button.primary-btn:hover {
      background-color: #0066CC;
    }

    /* Style des résultats */
    .result {
      background: var(--light-gray);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 16px;
      font-family: 'SF Pro';
    }

    /* Style du footer */
    footer {
      background-color: var(--background-color);
      color: #8E8E93;
      padding: 10px 0;
      text-align: center;
      width: 100%;
      font-size: 14px;
      border-top: 1px solid #E5E5EA;
      position: fixed;
      bottom: 0;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      nav button {
        padding: 8px 10px;
        font-size: 12px;
      }

      header h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo PhysioCare">
    <h1>PhysioCare Pro</h1>
  </header>

  <nav>
    <button class="active" onclick="showStep(1)">
      <i class="fas fa-user"></i>
      <span>Infos Patient</span>
    </button>
    <button onclick="showStep(2)">
      <i class="fas fa-notes-medical"></i>
      <span>Symptômes</span>
    </button>
    <button onclick="showStep(3)">
      <i class="fas fa-diagnoses"></i>
      <span>Diagnostic</span>
    </button>
    <button onclick="showStep(4)">
      <i class="fas fa-stethoscope"></i>
      <span>Traitement</span>
    </button>
  </nav>

  <!-- Étape 1 : Informations Patient -->
  <div class="container active" id="step1">
    <h2>Informations du Patient</h2>
    <label for="gender">Genre :</label>
    <select id="gender">
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
      <option value="Autre">Autre</option>
    </select>

    <label for="age">Âge :</label>
    <input type="number" id="age" placeholder="Exemple : 45">

    <label for="weight">Poids (kg) :</label>
    <input type="number" id="weight" placeholder="Exemple : 70">

    <label for="height">Taille (cm) :</label>
    <input type="number" id="height" placeholder="Exemple : 175">

    <label for="sport">Activité Sportive :</label>
    <select id="sport">
      <option value="Aucune">Aucune</option>
      <option value="Occasionnelle">Occasionnelle</option>
      <option value="Régulière">Régulière</option>
      <option value="Professionnelle">Professionnelle</option>
    </select>

    <label for="conditions">Conditions Médicales Spécifiques :</label>
    <textarea id="conditions" placeholder="Exemple : Diabète, hypertension, etc."></textarea>
  </div>

  <!-- Étape 2 : Symptômes -->
  <div class="container" id="step2">
    <h2>Symptômes et Analyses Médicales</h2>
    <label for="symptoms">Symptômes :</label>
    <textarea id="symptoms" placeholder="Exemple : Douleur au dos, faiblesse musculaire..."></textarea>

    <label for="fileInput">Télécharger des fichiers d'analyse (PDF ou Images) :</label>
    <input type="file" id="fileInput" multiple accept="image/*,application/pdf">
  </div>

  <!-- Étape 3 : Diagnostic -->
  <div class="container" id="step3">
    <h2>Diagnostic</h2>
    <button class="primary-btn" onclick="confirmGenerateDiagnosis()">Obtenir le Diagnostic</button>
    <div id="diagnosisResult" class="result">Résultat du diagnostic : En attente...</div>
    <div id="loader" style="display: none;">
      <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i> Analyse en cours...
    </div>
  </div>

  <!-- Étape 4 : Plan de Traitement -->
  <div class="container" id="step4">
    <h2>Plan de Traitement</h2>
    <div id="treatmentPlan" class="result">
      En attente du diagnostic pour générer le plan de traitement...
    </div>
  </div>

  <footer>
    © 2024 PhysioCare Pro - Votre Assistant Kinésithérapeute Intelligent
  </footer>

  <script>
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) container.classList.add('active');
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    async function extractTextFromFiles(files) {
      let extractedText = '';
      for (const file of files) {
        if (file.type === 'application/pdf') {
          extractedText += await extractTextFromPDF(file);
        } else if (file.type.startsWith('image/')) {
          extractedText += await extractTextFromImage(file);
        }
      }
      return extractedText;
    }

    function extractTextFromPDF(file) {
      return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(pdf => {
            let textContent = '';
            let pagePromises = [];
            for (let i = 1; i <= pdf.numPages; i++) {
              pagePromises.push(pdf.getPage(i).then(page => {
                return page.getTextContent().then(content => {
                  content.items.forEach(item => {
                    textContent += item.str + ' ';
                  });
                });
              }));
            }
            Promise.all(pagePromises).then(() => {
              resolve(textContent);
            });
          });
        };
        fileReader.readAsArrayBuffer(file);
      });
    }

    function extractTextFromImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          Tesseract.recognize(
            e.target.result,
            'fra',
            { logger: m => console.log(m) }
          ).then(({ data: { text } }) => {
            resolve(text);
          });
        };
        reader.readAsDataURL(file);
      });
    }

    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value;
      const symptoms = document.getElementById("symptoms").value;
      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");
      const files = document.getElementById("fileInput").files;

      diagnosisResult.textContent = "";
      loader.style.display = "block";

      let filesContent = '';
      if (files.length > 0) {
        filesContent = await extractTextFromFiles(files);
      }

      const combinedSymptoms = symptoms + '\n' + filesContent;

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `Patient: Genre : ${gender}, Âge : ${age}, Poids : ${weight}, Taille : ${height}, Sport : ${sport}, Conditions médicales : ${conditions}, Symptômes et analyses : ${combinedSymptoms}.`,
              },
            ],
          }),
        });

        const data = await response.json();
        const diagnosisText = data.content.trim();
        diagnosisResult.innerHTML = formatDiagnosis(diagnosisText);

        generateTreatmentPlan(gender, age, weight, height, sport, conditions, combinedSymptoms, diagnosisText);
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    function formatDiagnosis(text) {
      // Formatage du diagnostic pour une meilleure lisibilité
      return text.replace(/\n/g, '<br>');
    }

    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.textContent = "Création du plan de traitement en cours...";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes et analyses: ${symptoms}

Diagnostic: ${diagnosis}

Tâche : Basé sur les informations ci-dessus, générez une **proposition théorique de protocole de soins très précis et personnalisé à valider par un kinésithérapeute**, parfaitement adapté aux spécificités du patient et de ses symptômes, et basé uniquement sur l'état de l'art le plus fiable et récent dans le domaine de la kinésithérapie. Ne donnez pas de diagnostic. Précisez que ce protocole doit impérativement être validé par un professionnel avant application. **Structurez la réponse avec des titres, des sous-titres et des listes à puces**, et fournissez des recommandations deux fois plus détaillées qu'auparavant pour les soins, exercices ou traitements.
`,
              },
            ],
          }),
        });

        const data = await response.json();
        treatmentPlan.innerHTML = formatTreatmentPlan(data.content.trim());
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }

    function formatTreatmentPlan(text) {
      // Formatage du plan de traitement pour une meilleure lisibilité
      return text.replace(/\n/g, '<br>');
    }
  </script>
</body>
</html>
