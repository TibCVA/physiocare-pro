<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare</title>
  <!-- Importation des polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Importation des icônes (Font Awesome pour cet exemple) -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Importation de jsPDF pour la génération du PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <style>
    /* Votre CSS actuel reste inchangé */
    /* ... (votre CSS existant) ... */
  </style>
</head>

<body>
  <header>
    <img src="logo.png" alt="Logo PhysioCare">
    <h1>PhysioCare</h1>
  </header>

  <nav>
    <button class="active" onclick="showStep(1)">
      <i class="fas fa-user"></i>
      <span>Infos</span>
    </button>
    <button onclick="showStep(2)">
      <i class="fas fa-notes-medical"></i>
      <span>Symptômes</span>
    </button>
    <button onclick="showStep(3)">
      <i class="fas fa-stethoscope"></i>
      <span>Diagnostic</span>
    </button>
    <button onclick="showStep(4)">
      <i class="fas fa-file-prescription"></i>
      <span>Traitement</span>
    </button>
  </nav>

  <!-- Message de confirmation -->
  <div id="confirmationMessage" class="confirmation-message">
    <i class="fas fa-check-circle"></i>
    <span id="confirmationText"></span>
  </div>

  <!-- Étape 1 : Informations Patient -->
  <div class="container active" id="step1">
    <h2>Informations du Patient</h2>

    <div class="form-group">
      <label for="gender">Genre</label>
      <select id="gender" required>
        <option value="" disabled selected>Sélectionnez le genre</option>
        <option value="Homme">Homme</option>
        <option value="Femme">Femme</option>
        <option value="Autre">Autre</option>
      </select>
    </div>

    <div class="form-group">
      <label for="age">Âge</label>
      <select id="age" required>
        <option value="" disabled selected>Sélectionnez l'âge</option>
        <option value="18-30">18-30</option>
        <option value="31-50">31-50</option>
        <option value="51-70">51-70</option>
        <option value="71+">71+</option>
      </select>
    </div>

    <div class="form-group">
      <label for="weight">Poids (kg)</label>
      <input type="number" id="weight" placeholder="Entrez le poids" required>
    </div>

    <div class="form-group">
      <label for="height">Taille (cm)</label>
      <input type="number" id="height" placeholder="Entrez la taille" required>
    </div>

    <div class="form-group">
      <label for="sport">Activité Sportive</label>
      <select id="sport" required>
        <option value="" disabled selected>Sélectionnez le niveau d'activité</option>
        <option value="Aucune">Aucune</option>
        <option value="Occasionnelle">Occasionnelle</option>
        <option value="Régulière">Régulière</option>
        <option value="Professionnelle">Professionnelle</option>
      </select>
    </div>

    <div class="form-group">
      <label for="conditions">Conditions Médicales Spécifiques</label>
      <textarea id="conditions" placeholder="Décrivez les conditions médicales spécifiques"></textarea>
    </div>
  </div>

  <!-- Étape 2 : Symptômes et Analyses Médicales -->
  <div class="container" id="step2">
    <h2>Symptômes et Analyses Médicales</h2>

    <div class="form-group">
      <label for="symptoms">Symptômes</label>
      <textarea id="symptoms" placeholder="Décrivez les symptômes observés chez le patient..."></textarea>
    </div>

    <div class="form-group" style="text-align: center;">
      <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="display: none;">
      <label for="fileInput" style="cursor: pointer;">
        <i class="fas fa-upload"></i> Choisir les fichiers
      </label>
      <div id="filePreview"></div>
    </div>

    <button class="primary-btn" onclick="uploadFiles()">
      Télécharger et Analyser les Fichiers
    </button>
  </div>

  <!-- Étape 3 : Diagnostic -->
  <div class="container" id="step3">
    <h2>Diagnostic</h2>
    <button class="primary-btn" onclick="confirmGenerateDiagnosis()">
      Obtenir le Diagnostic
    </button>
    <div id="loader" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i>&nbsp;Analyse en cours...
    </div>
    <div class="result" id="diagnosisResult">Résultat du diagnostic : En attente...</div>
  </div>

  <!-- Étape 4 : Plan de Traitement -->
  <div class="container" id="step4">
    <h2>Plan de Traitement</h2>
    <div class="result" id="treatmentPlan">
      En attente du diagnostic pour générer le plan de traitement...
    </div>
    <button class="primary-btn download-btn" onclick="downloadTreatmentPlanPDF()">
      <i class="fas fa-file-download"></i> Télécharger le Plan de Traitement
    </button>
  </div>

  <!-- Footer -->
  <footer>
    &copy; Thibaut Lacour 2024, All rights reserved.
  </footer>

  <!-- Scripts -->
  <script>
    // Variables globales
    let ocrText = ''; // Variable pour stocker le texte OCR extrait

    // Prévisualisation des fichiers téléchargés
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const confirmationMessage = document.getElementById('confirmationMessage');
    const confirmationText = document.getElementById('confirmationText');

    fileInput.addEventListener('change', () => {
      filePreview.innerHTML = '';
      Array.from(fileInput.files).forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.textContent = file.name;
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        removeBtn.onclick = () => {
          fileDiv.remove();
          // Retirer le fichier de l'input
          const dt = new DataTransfer();
          Array.from(fileInput.files)
            .filter(f => f !== file)
            .forEach(f => dt.items.add(f));
          fileInput.files = dt.files;
          if (fileInput.files.length === 0) {
            showConfirmation("Tous les fichiers ont été supprimés");
          }
        };
        fileDiv.appendChild(removeBtn);
        filePreview.appendChild(fileDiv);
      });
      if (fileInput.files.length > 0) {
        showConfirmation("Fichier(s) téléchargé(s) avec succès");
      }
    });

    function showConfirmation(message) {
      confirmationText.textContent = message;
      confirmationMessage.classList.add('show');
      setTimeout(() => {
        confirmationMessage.classList.remove('show');
      }, 3000);
    }

    // Navigation avec animations
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) {
          container.classList.add('active');
          container.scrollIntoView({ behavior: 'smooth' });
        }
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    // Confirmation et génération du diagnostic
    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    // Génération du diagnostic
    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value.trim(); // Trim pour enlever les espaces inutiles
      const symptoms = document.getElementById("symptoms").value.trim();

      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");

      diagnosisResult.innerHTML = "";
      loader.style.display = "flex";

      // Log des données collectées
      console.log('Données collectées pour le diagnostic :', {
        gender,
        age,
        weight,
        height,
        sport,
        conditions,
        symptoms,
        ocrText
      });

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            profile: `
              - Genre : ${gender}
              - Âge : ${age}
              - Poids : ${weight} kg
              - Taille : ${height} cm
              - Activité Sportive : ${sport}
              - Conditions Médicales Spécifiques : ${conditions}
            `,
            symptoms: symptoms,
            ocrText: ocrText
          }),
        });

        const data = await response.json();

        console.log('Réponse du diagnostic backend :', data);

        if (response.ok) {
          if (data && data.content) {
            const diagnosisText = data.content.trim();
            diagnosisResult.innerHTML = formatDiagnosisText(diagnosisText);
            showConfirmation("Diagnostic généré avec succès");

            // Générer le plan de traitement après avoir reçu le diagnostic
            generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosisText);
          } else {
            throw new Error("Réponse inattendue de l'API.");
          }
        } else {
          // Gérer les erreurs retournées par le backend
          if (data && data.error) {
            diagnosisResult.textContent = `Erreur : ${data.error}`;
            console.error("Erreur API:", data.error);
          } else {
            diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
            console.error("Erreur API inconnue.");
          }
        }
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    // Fonction pour formater le texte du diagnostic avec des titres gras
    function formatDiagnosisText(text) {
      const lines = text.split('\n').map(line => {
        if (line.startsWith("Recommandations") || line.startsWith("Données Manquantes")) {
          return `<strong>${line}</strong>`;
        }
        return line;
      }).join('<br>');
      return lines;
    }

    // Génération du plan de traitement
    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.innerHTML = "Création du plan de traitement en cours...";

      // Log des données envoyées pour le plan de traitement
      console.log('Données envoyées pour le plan de traitement :', {
        profile: `
          - Genre : ${gender}
          - Âge : ${age}
          - Poids : ${weight} kg
          - Taille : ${height} cm
          - Activité Sportive : ${sport}
          - Conditions Médicales Spécifiques : ${conditions}
        `,
        symptoms: symptoms,
        diagnostic: diagnosis
      });

      try {
        const response = await fetch("/.netlify/functions/treatmentPlan", { // Assurez-vous que cette fonction existe
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            profile: `
              - Genre : ${gender}
              - Âge : ${age}
              - Poids : ${weight} kg
              - Taille : ${height} cm
              - Activité Sportive : ${sport}
              - Conditions Médicales Spécifiques : ${conditions}
            `,
            symptoms: symptoms,
            diagnostic: diagnosis
          }),
        });

        const data = await response.json();

        console.log('Réponse du plan de traitement backend :', data);

        if (response.ok) {
          if (data && data.content) {
            const treatmentText = data.content.trim();
            treatmentPlan.innerHTML = formatTreatmentPlan(treatmentText);
            showConfirmation("Plan de traitement généré avec succès");
          } else {
            throw new Error("Réponse inattendue de l'API.");
          }
        } else {
          // Gérer les erreurs retournées par le backend
          if (data && data.error) {
            treatmentPlan.textContent = `Erreur : ${data.error}`;
            console.error("Erreur API:", data.error);
          } else {
            treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
            console.error("Erreur API inconnue.");
          }
        }
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }

    // Fonction pour formater le plan de traitement avec une structure bien définie
    function formatTreatmentPlan(text) {
      // Remplacer les sections par des balises appropriées et formatage du texte
      // Exemple de format : des titres en gras et des listes à puces pour les exercices et soins
      const formattedText = text.replace(/Exercice/g, '<strong>Exercice</strong>')
        .replace(/Soins/g, '<strong>Soins</strong>')
        .replace(/\n/g, '<br>');
      return formattedText;
    }

    // Téléchargement du plan de traitement en PDF
    async function downloadTreatmentPlanPDF() {
      const { jsPDF } = window.jspdf;
      const treatmentPlanElement = document.getElementById('treatmentPlan');

      try {
        // Initialisation de jsPDF
        const pdf = new jsPDF();

        // Configuration initiale du PDF
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text("Plan de Traitement Personnalisé", 10, 20);
        pdf.setFontSize(12);
        const currentDate = new Date().toLocaleDateString('fr-FR');
        pdf.text(`Date de génération: ${currentDate}`, 10, 30);

        // Ajout du contenu du plan de traitement
        pdf.setFont('helvetica', 'normal');
        pdf.setFontSize(12);
        const lines = treatmentPlanElement.innerText.split('\n');
        let y = 40;
        lines.forEach(line => {
          if (y > 280) { // Limite de la page A4 en mm
            pdf.addPage();
            y = 20;
          }
          pdf.text(line, 10, y);
          y += 10;
        });

        // Sauvegarde du PDF
        pdf.save("Plan_de_Traitement.pdf");
        showConfirmation("Plan de traitement téléchargé avec succès");
      } catch (error) {
        console.error("Erreur lors de la génération du PDF :", error);
        showConfirmation("Erreur lors du téléchargement du plan de traitement.");
      }
    }

    // Fonction pour envoyer les fichiers au backend et analyser le texte
    async function uploadFiles() {
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;
      const formData = new FormData();

      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }

      try {
        const response = await fetch('/.netlify/functions/uploadFiles', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          showConfirmation("Fichiers analysés avec succès");
          // Stocker le texte OCR pour une utilisation ultérieure
          ocrText = data.ocrText;
          console.log('Texte OCR extrait:', ocrText);
        } else {
          showConfirmation("Erreur lors de l'analyse des fichiers");
          console.error('Erreur uploadFiles:', data.error);
        }
      } catch (error) {
        console.error("Erreur lors du chargement des fichiers:", error);
        showConfirmation("Erreur lors du chargement des fichiers");
      }
    }
  </script>
</body>

</html>