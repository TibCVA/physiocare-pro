<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare Pro</title>
  <!-- Importation des polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet">
  <!-- Importation des icônes SF Symbols via une alternative web -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Variables CSS pour les couleurs */
    :root {
      --primary-color: #005F9E;
      --secondary-color: #333333;
      --accent-color: #58C493;
      --background-color: #FFFFFF;
      --text-color: #1C1C1E;
      --light-gray: #E0E0E0;
      --card-background: #FFFFFF;
      --card-shadow: rgba(0, 0, 0, 0.05);
      --highlight-color: rgba(88, 196, 147, 0.3);
      --error-color: #FF3B30;
      --success-color: #4CD964;
    }

    /* Styles globaux */
    html, body {
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: var(--text-color);
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
    }

    /* Style du header */
    header {
      background: var(--primary-color);
      color: white;
      width: 100%;
      padding: 15px 20px;
      position: fixed;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header img {
      width: 35px;
      border-radius: 8px;
      margin-right: 15px;
    }

    header h1 {
      font-size: 24px;
      margin: 0;
      font-weight: 700;
      flex-grow: 1;
      text-align: center;
    }

    /* Style de la navigation */
    nav {
      background: var(--card-background);
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 5px 0;
      position: fixed;
      bottom: 0;
      z-index: 999;
      border-top: 1px solid var(--light-gray);
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
    }

    nav button {
      background: none;
      border: none;
      padding: 10px;
      font-size: 12px;
      cursor: pointer;
      color: var(--text-color);
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: color 0.3s ease;
      position: relative;
    }

    nav button.active {
      color: var(--primary-color);
    }

    nav button.active::after {
      content: '';
      position: absolute;
      bottom: -5px;
      width: 40%;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }

    nav button i {
      font-size: 24px;
      margin-bottom: 3px;
    }

    /* Style des conteneurs */
    .container {
      max-width: 600px;
      width: 90%;
      margin-top: 100px;
      margin-bottom: 100px;
      padding: 20px;
      background: var(--card-background);
      border-radius: 20px;
      box-shadow: 0 4px 16px var(--card-shadow);
      display: none;
      margin-left: auto;
      margin-right: auto;
    }

    .container.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 {
      color: var(--primary-color);
      margin-bottom: 24px;
      font-weight: 700;
      font-size: 24px;
      text-align: center;
    }

    /* Formulaires */
    .form-group {
      margin-bottom: 24px;
      position: relative;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      background-color: #F9F9F9;
      font-size: 16px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary-color);
      background-color: #fff;
    }

    .form-group label {
      position: absolute;
      top: 14px;
      left: 16px;
      font-size: 16px;
      color: #999;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .form-group input:not(:placeholder-shown) + label,
    .form-group input:focus + label,
    .form-group select:not(:placeholder-shown) + label,
    .form-group select:focus + label,
    .form-group textarea:not(:placeholder-shown) + label,
    .form-group textarea:focus + label {
      top: -10px;
      left: 12px;
      font-size: 12px;
      background: #fff;
      padding: 0 4px;
      color: var(--primary-color);
    }

    /* Boutons */
    .primary-btn {
      width: 100%;
      padding: 14px;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .primary-btn:hover {
      background-color: #007BCE;
    }

    .primary-btn:active {
      background-color: #00477C;
      transform: scale(0.98);
    }

    /* Loader */
    #loader {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      font-size: 18px;
      color: var(--primary-color);
    }

    /* Résultats */
    .result {
      background: var(--light-gray);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .result strong {
      font-weight: 700;
    }

    /* Prévisualisation des fichiers */
    #filePreview div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #F9F9F9;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }

    #filePreview button {
      background: none;
      border: none;
      color: var(--error-color);
      cursor: pointer;
    }

    /* Espacement entre sections */
    .section-divider {
      margin-top: 24px;
      margin-bottom: 24px;
      border-top: 1px solid var(--light-gray);
    }

    /* Responsive */
    @media (max-width: 600px) {
      header h1 {
        font-size: 22px;
      }

      h2 {
        font-size: 22px;
      }

      .primary-btn {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <header>
    <img src="logo.png" alt="Logo PhysioCare">
    <h1>PhysioCare Pro</h1>
  </header>

  <nav>
    <button class="active" onclick="showStep(1)">
      <i class="fas fa-user"></i>
      <span>Infos</span>
    </button>
    <button onclick="showStep(2)">
      <i class="fas fa-notes-medical"></i>
      <span>Symptômes</span>
    </button>
    <button onclick="showStep(3)">
      <i class="fas fa-stethoscope"></i>
      <span>Diagnostic</span>
    </button>
    <button onclick="showStep(4)">
      <i class="fas fa-file-prescription"></i>
      <span>Traitement</span>
    </button>
  </nav>

  <!-- Étape 1 : Informations Patient -->
  <div class="container active" id="step1">
    <h2>Informations du Patient</h2>

    <div class="form-group">
      <select id="gender" required>
        <option value="" disabled selected></option>
        <option value="Homme">Homme</option>
        <option value="Femme">Femme</option>
        <option value="Autre">Autre</option>
      </select>
      <label for="gender">Genre</label>
    </div>

    <div class="form-group">
      <select id="age" required>
        <option value="" disabled selected></option>
        <option value="18-30">18-30</option>
        <option value="31-50">31-50</option>
        <option value="51-70">51-70</option>
        <option value="71+">71+</option>
      </select>
      <label for="age">Âge</label>
    </div>

    <div class="form-group">
      <input type="number" id="weight" placeholder=" " required>
      <label for="weight">Poids (kg)</label>
    </div>

    <div class="form-group">
      <input type="number" id="height" placeholder=" " required>
      <label for="height">Taille (cm)</label>
    </div>

    <div class="form-group">
      <select id="sport" required>
        <option value="" disabled selected></option>
        <option value="Aucune">Aucune</option>
        <option value="Occasionnelle">Occasionnelle</option>
        <option value="Régulière">Régulière</option>
        <option value="Professionnelle">Professionnelle</option>
      </select>
      <label for="sport">Activité Sportive</label>
    </div>

    <div class="form-group">
      <textarea id="conditions" placeholder=" "></textarea>
      <label for="conditions">Conditions Médicales Spécifiques</label>
    </div>

  </div>

  <!-- Étape 2 : Symptômes et Analyses Médicales -->
  <div class="container" id="step2">
    <h2>Symptômes et Analyses Médicales</h2>

    <div class="form-group">
      <!-- Éditeur de texte enrichi -->
      <div id="symptomsEditor"></div>
      <label for="symptomsEditor">Symptômes</label>
    </div>

    <div class="form-group">
      <input type="file" id="fileInput" multiple accept="image/*,application/pdf">
      <label for="fileInput"><i class="fas fa-upload"></i> Télécharger des fichiers d'analyse</label>
      <div id="filePreview"></div>
    </div>
  </div>

  <!-- Étape 3 : Diagnostic -->
  <div class="container" id="step3">
    <h2>Diagnostic</h2>
    <button class="primary-btn" onclick="confirmGenerateDiagnosis()">
      Obtenir le Diagnostic
    </button>
    <div id="loader" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i>&nbsp;Analyse en cours...
    </div>
    <div id="diagnosisResult" class="result">Résultat du diagnostic : En attente...</div>
  </div>

  <!-- Étape 4 : Plan de Traitement -->
  <div class="container" id="step4">
    <h2>Plan de Traitement</h2>
    <div id="treatmentPlan" class="result">
      En attente du diagnostic pour générer le plan de traitement...
    </div>
    <button class="primary-btn" onclick="downloadTreatmentPlanPDF()">
      Télécharger le Plan de Traitement en PDF
    </button>
  </div>

  <!-- Scripts -->
  <!-- Inclusion de l'éditeur de texte enrichi Quill -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script>
    // Initialisation de l'éditeur Quill
    var quill = new Quill('#symptomsEditor', {
      theme: 'snow',
      placeholder: 'Décrivez les symptômes du patient...'
    });

    // Prévisualisation des fichiers téléchargés
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');

    fileInput.addEventListener('change', () => {
      filePreview.innerHTML = '';
      Array.from(fileInput.files).forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.textContent = file.name;
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        removeBtn.onclick = () => {
          fileDiv.remove();
          // Retirer le fichier de l'input
          const dt = new DataTransfer();
          Array.from(fileInput.files)
            .filter(f => f !== file)
            .forEach(f => dt.items.add(f));
          fileInput.files = dt.files;
        };
        fileDiv.appendChild(removeBtn);
        filePreview.appendChild(fileDiv);
      });
    });

    // Navigation avec animations
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) {
          container.classList.add('active');
          container.scrollIntoView({ behavior: 'smooth' });
        }
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    // Confirmation et génération du diagnostic
    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    // Génération du diagnostic
    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value;
      const symptoms = quill.root.innerHTML; // Obtenir le contenu riche

      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");

      diagnosisResult.textContent = "";
      loader.style.display = "flex";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `Patient: Genre : ${gender}, Âge : ${age}, Poids : ${weight}, Taille : ${height}, Sport : ${sport}, Conditions médicales : ${conditions}, Symptômes : ${symptoms}.`,
              },
            ],
          }),
        });

        const data = await response.json();

        // Vérifier si la réponse contient le contenu attendu
        if (data && data.content) {
          const diagnosisText = data.content.trim();
          diagnosisResult.innerHTML = diagnosisText;
          generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosisText);
        } else {
          throw new Error("Réponse inattendue de l'API.");
        }
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    // Génération du plan de traitement
    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.textContent = "Création du plan de traitement en cours...";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes: ${symptoms}

Diagnostic: ${diagnosis}

Tâche : Basé sur les informations ci-dessus, générez une **proposition théorique de protocole de soins très précis et personnalisé à valider par un kinésithérapeute**, parfaitement adapté aux spécificités du patient et de ses symptômes et basé uniquement sur l'état de l'art le plus fiable et récent dans le domaine de la kinésithérapie. Ne donnez pas de diagnostic. Précisez que ce protocole doit impérativement être validé par un professionnel avant application. Répondez uniquement sous la forme d'une liste à puces avec des **recommandations claires** pour les soins, exercices ou traitements.`,
              },
            ],
          }),
        });

        const data = await response.json();

        // Vérifier si la réponse contient le contenu attendu
        if (data && data.content) {
          const treatmentText = data.content.trim();
          // Structurer le contenu avec des titres numérotés
          treatmentPlan.innerHTML = treatmentText;
        } else {
          throw new Error("Réponse inattendue de l'API.");
        }
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }

    // Téléchargement du plan de traitement en PDF
    function downloadTreatmentPlanPDF() {
      const { jsPDF } = window.jspdf;
      const treatmentPlanText = document.getElementById('treatmentPlan').innerText;

      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Plan de Traitement Personnalisé", 10, 10);
      doc.setFontSize(12);
      doc.text(treatmentPlanText, 10, 20, { maxWidth: 180 });

      doc.save("Plan_de_Traitement.pdf");
    }
  </script>
</body>

</html>
