<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>PhysioCare Pro</title>
  <!-- Importation des polices -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Importation de Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha384-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Importation de PDF.js pour l'extraction de texte des PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <!-- Importation de Tesseract.js pour l'OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    /* Styles identiques à votre code actuel */
    /* ... (le code CSS reste inchangé) ... */
  </style>
</head>
<body>
  <!-- Contenu HTML identique à votre code actuel -->
  <!-- ... (le code HTML reste inchangé) ... -->

  <!-- Votre code JavaScript mis à jour -->
  <script>
    // Fonction pour afficher l'étape sélectionnée
    function showStep(step) {
      const steps = document.querySelectorAll('.container');
      const buttons = document.querySelectorAll('nav button');
      steps.forEach((container, index) => {
        container.classList.remove('active');
        if (index + 1 === step) container.classList.add('active');
      });
      buttons.forEach((button, index) => {
        button.classList.remove('active');
        if (index + 1 === step) button.classList.add('active');
      });
    }

    // Fonction pour confirmer la génération du diagnostic
    function confirmGenerateDiagnosis() {
      if (confirm("Voulez-vous vraiment générer le diagnostic avec les informations fournies ?")) {
        generateDiagnosis();
      }
    }

    // Fonction pour extraire le texte des fichiers PDF
    async function extractTextFromPDF(file) {
      return new Promise((resolve, reject) => {
        const fileReader = new FileReader();

        fileReader.onload = function() {
          const typedarray = new Uint8Array(this.result);

          pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            let maxPages = pdf.numPages;
            let countPromises = []; // collecte des promesses pour chaque page
            for (let j = 1; j <= maxPages; j++) {
              let page = pdf.getPage(j);

              countPromises.push(page.then(function(page) {
                // promesse pour la page
                let textContent = page.getTextContent();
                return textContent.then(function(text) {
                  return text.items.map(function (s) { return s.str; }).join(' ');
                });
              }));
            }
            Promise.all(countPromises).then(function (texts) {
              resolve(texts.join(' '));
            });
          });
        };

        fileReader.onerror = function(error) {
          reject(error);
        };

        fileReader.readAsArrayBuffer(file);
      });
    }

    // Fonction pour extraire le texte des images via OCR
    async function extractTextFromImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function() {
          Tesseract.recognize(
            reader.result,
            'fra', // Utilisation du modèle français
            { logger: m => console.log(m) }
          ).then(({ data: { text } }) => {
            resolve(text);
          }).catch(error => {
            reject(error);
          });
        };
        reader.onerror = function(error) {
          reject(error);
        };
        reader.readAsDataURL(file);
      });
    }

    // Fonction pour générer le diagnostic
    async function generateDiagnosis() {
      const gender = document.getElementById("gender").value;
      const age = document.getElementById("age").value;
      const weight = document.getElementById("weight").value;
      const height = document.getElementById("height").value;
      const sport = document.getElementById("sport").value;
      const conditions = document.getElementById("conditions").value;
      const symptoms = document.getElementById("symptoms").value;
      const diagnosisResult = document.getElementById("diagnosisResult");
      const loader = document.getElementById("loader");

      diagnosisResult.textContent = "";
      loader.style.display = "block";

      // Traitement des fichiers téléchargés
      const fileInput = document.getElementById("fileInput");
      const files = fileInput.files;
      let extractedTexts = [];

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type === "application/pdf") {
          // Extraction du texte du PDF
          try {
            const text = await extractTextFromPDF(file);
            extractedTexts.push(text);
          } catch (error) {
            console.error("Erreur lors de l'extraction du texte du PDF :", error);
          }
        } else if (file.type.startsWith("image/")) {
          // Extraction du texte de l'image via OCR
          try {
            const text = await extractTextFromImage(file);
            extractedTexts.push(text);
          } catch (error) {
            console.error("Erreur lors de l'extraction du texte de l'image :", error);
          }
        }
      }

      // Combinaison des textes extraits
      const analysisTexts = extractedTexts.join("\n");

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes: ${symptoms}
- Texte des documents PDF et images: ${analysisTexts}

Veuillez fournir un diagnostic détaillé en tenant compte de toutes les informations ci-dessus. La réponse doit être bien structurée et deux fois plus détaillée que précédemment.`,
              },
            ],
          }),
        });

        const data = await response.json();
        const diagnosisText = data.content.trim();
        diagnosisResult.textContent = diagnosisText;

        generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosisText, analysisTexts);
      } catch (error) {
        diagnosisResult.textContent = "Erreur lors de l'établissement du diagnostic.";
        console.error("Erreur API:", error);
      } finally {
        loader.style.display = "none";
      }
    }

    // Fonction pour générer le plan de traitement
    async function generateTreatmentPlan(gender, age, weight, height, sport, conditions, symptoms, diagnosis, analysisTexts) {
      const treatmentPlan = document.getElementById("treatmentPlan");
      treatmentPlan.textContent = "Création du plan de traitement en cours...";

      try {
        const response = await fetch("/.netlify/functions/diagnosis", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-3-5-sonnet-20241022",
            max_tokens: 5000,
            messages: [
              {
                role: "user",
                content: `
Patient:
- Genre: ${gender}
- Âge: ${age}
- Poids: ${weight}
- Taille: ${height}
- Sport: ${sport}
- Conditions médicales spécifiques: ${conditions}
- Symptômes: ${symptoms}
- Texte des documents PDF et images: ${analysisTexts}

Diagnostic: ${diagnosis}

Tâche : Basé sur les informations ci-dessus, générez une **proposition théorique de protocole de soins très précis et personnalisé à valider par un kinésithérapeute**, parfaitement adapté aux spécificités du patient et de ses symptômes, en intégrant les résultats des analyses médicales fournies. Le protocole doit être bien structuré, deux fois plus détaillé que précédemment, et basé uniquement sur l'état de l'art le plus fiable et récent dans le domaine de la kinésithérapie. Ne donnez pas de diagnostic. Précisez que ce protocole doit impérativement être validé par un professionnel avant application. Répondez en utilisant des titres, sous-titres, et listes à puces avec des **recommandations claires** pour les soins, exercices ou traitements.`,
              },
            ],
          }),
        });

        const data = await response.json();
        treatmentPlan.textContent = data.content.trim();
      } catch (error) {
        treatmentPlan.textContent = "Erreur lors de la création du plan de traitement.";
        console.error("Erreur complète :", error);
      }
    }
  </script>
</body>
</html>
